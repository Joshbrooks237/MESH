# SETI Cancer Research Universe - Logstash Configuration

input {
  # Backend application logs
  file {
    path => "/var/log/seti/backend/*.log"
    start_position => "beginning"
    type => "backend"
    tags => ["backend", "application"]
  }

  # Task server logs
  file {
    path => "/var/log/seti/task-server/*.log"
    start_position => "beginning"
    type => "task-server"
    tags => ["task-server", "distributed-computing"]
  }

  # Nginx access logs
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    type => "nginx-access"
    tags => ["nginx", "web-server"]
  }

  # Nginx error logs
  file {
    path => "/var/log/nginx/error.log"
    start_position => "beginning"
    type => "nginx-error"
    tags => ["nginx", "web-server", "error"]
  }

  # System logs
  syslog {
    port => 514
    type => "syslog"
    tags => ["system", "syslog"]
  }

  # Docker container logs
  docker {
    host => "unix:///var/run/docker.sock"
    container_logs => {
      "seti-backend" => "backend"
      "seti-frontend" => "frontend"
      "seti-task-server" => "task-server"
      "seti-mongodb" => "database"
      "seti-redis" => "cache"
    }
  }
}

filter {
  # Parse JSON logs
  if [type] in ["backend", "task-server"] {
    json {
      source => "message"
      remove_field => ["message"]
    }
  }

  # Parse Nginx access logs
  if [type] == "nginx-access" {
    grok {
      match => {
        "message" => '%{IPORHOST:clientip} %{HTTPDUSER:ident} %{HTTPDUSER:auth} \[%{HTTPDATE:timestamp}\] "%{WORD:verb} %{DATA:request} HTTP/%{NUMBER:httpversion}" %{NUMBER:response:int} %{NUMBER:bytes:int} %{QS:referrer} %{QS:agent}'
      }
    }

    date {
      match => ["timestamp", "dd/MMM/yyyy:HH:mm:ss Z"]
      target => "@timestamp"
    }

    geoip {
      source => "clientip"
      target => "geoip"
    }

    useragent {
      source => "agent"
      target => "useragent"
    }
  }

  # Add timestamp if missing
  if ![@timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Add host information
  mutate {
    add_field => {
      "host" => "%{[@metadata][hostname]}"
      "service" => "%{[type]}"
    }
  }

  # Filter sensitive data
  mutate {
    remove_field => ["password", "token", "secret", "key"]
  }

  # Add research-specific fields
  if [message] =~ /research|project|task/ {
    mutate {
      add_tag => "research"
    }
  }

  # Performance monitoring
  if [response] {
    if [response] >= 400 {
      mutate {
        add_tag => "error"
      }
    }
  }
}

output {
  # Main Elasticsearch output
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "seti-cancer-%{+YYYY.MM.dd}"
    document_type => "%{[@metadata][type]}"
  }

  # Error logs to separate index
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "seti-cancer-errors-%{+YYYY.MM.dd}"
      document_type => "error"
    }
  }

  # Research-specific logs
  if "research" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "seti-cancer-research-%{+YYYY.MM.dd}"
      document_type => "research"
    }
  }

  # Console output for debugging (remove in production)
  stdout {
    codec => rubydebug
  }
}
